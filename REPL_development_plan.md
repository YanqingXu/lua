# Lua REPL 开发计划

## 概述

本计划旨在为现有的 Lua 解释器项目实现一个交互式的 Read-Eval-Print Loop (REPL) 功能。这将允许用户直接在命令行中输入和执行 Lua 代码，从而提供一个更便捷的测试和调试环境。

## 开发阶段

### 第一阶段：基础 REPL 实现

此阶段的目标是创建一个可以工作的、最简化的 REPL。

1.  **创建 REPL 源文件**: 
    - 在 `src` 目录下创建一个新的 `repl.cpp` 文件。
    - 这将有助于将 REPL 的特定逻辑与现有的文件执行逻辑（可能在 `main.cpp` 中）分离开来。

2.  **实现核心 REPL 循环**:
    - 在 `repl.cpp` 中，实现一个无限循环，该循环将持续从标准输入（`stdin`）读取用户输入。

3.  **与 Lua 虚拟机集成**:
    - 对于从用户那里读取的每一行代码，都需要调用解释器核心功能来执行它。
    - 这将涉及到与词法分析器、解析器、编译器和虚拟机的交互。
    - 需要研究 `main.cpp` 中现有的代码执行流程，以了解如何正确地加载和执行一个字符串形式的 Lua 代码块。

4.  **处理基本输出**:
    - 将 Lua 代码执行后的任何返回值或错误信息打印到标准输出（`stdout`）。

5.  **更新构建系统**:
    - 修改 `lua.vcxproj` 项目文件，将 `repl.cpp` 添加到编译源中。
    - 考虑如何生成一个单独的 REPL 可执行程序，或者在现有的可执行文件中通过命令行参数来启动 REPL 模式。

### 第二阶段：高级功能和体验优化

在基础功能之上，此阶段将专注于提升 REPL 的用户体验和功能完整性。

1.  **支持多行输入**:
    - 实现逻辑来检测用户输入是否构成一个完整的 Lua 语句块。
    - 如果语句不完整（例如，一个 `function` 定义没有对应的 `end`），REPL 应该提示用户继续输入，直到语句完整为止。

2.  **命令历史记录**:
    - 集成一个第三方库（如 `readline` 或 `linenoise`）来提供命令行历史功能。
    - 用户应该能够使用上下箭头键来浏览之前输入的命令。

3.  **Tab 自动补全**:
    - 实现一个基本的自动补全系统。
    - 当用户按下 Tab 键时，REPL 应该能够提示 Lua 的关键字、全局变量和可用的函数名。
    - 这需要 REPL 能够查询当前的 Lua 全局环境。

4.  **改进错误处理**:
    - 优化错误信息的显示，使其对用户更加友好和易于理解。
    - 提供更清晰的错误来源指示（例如，行号和错误类型）。

5.  **沙箱环境 (可选)**:
    - 研究并考虑在一个受限的沙箱环境中运行 REPL。
    - 这将增加一层安全保障，防止执行潜在的恶意代码。

## 时间线和里程碑

- **第一周**: 完成第一阶段，实现一个可以基本工作的 REPL。
- **第二周至第三周**: 完成第二阶段的大部分功能，特别是多行输入和命令历史。
- **第四周**: 完善高级功能，进行测试和文档编写。